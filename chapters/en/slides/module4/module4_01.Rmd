---
params:
  dynamictitle: "module4_01"
title: "`r params$dynamictitle`"
output:
  md_document:
    variant: gfm
    pandoc_args: "--markdown-headings=atx"
---

```{r setup, include=FALSE}
source('../../../../slide-setup.R')
# Remember to also manually update the YAML title above
```

type: slides


# Visualizing multidimensional and categorical distributions

Notes:
In this slide deck,
we will extend what we learned in the previous module
about visualizing individual quantitative dataframe columns
as one-dimensional distributions
to also be able to visualize two-dimensional and categorical distributions.

---

## Reading in the data

```{python}
import altair as alt
import pandas as pd

movies_extended = pd.read_csv('data/movies-extended.csv')
movies_extended
```


Notes:
We're continuing to work with the movies data set.
Here we have done some additional preprocessing steps to to the data
and saved it to disk beforehand
so that we can load it in directly on this slide.

This is largely the same dataset as before,
but we filtered out some additional NaNs
and a few categories that contained problematic values.

---

## Scatter plots are effective visualizations for 2D distributions

```{python}
alt.Chart(movies_extended).mark_point().encode(
    alt.X('IMDB Rating'),
    alt.Y('Rotten Tomatoes Rating'))
```

Notes:
In the last module we saw how to visualize the distribution
of a single numerical dataframe column.
What if we instead want to compare the distributions
of two columns with each other?

A question we could answer with this type of comparison is
"Are movies rated similarly on different online platforms?"

In this slide we are showing the movie rating from both
https://www.imdb.com/ and https://www.rottentomatoes.com.
These are both websites where people can rate movies.

There is clearly a pattern in this scatter plot,
but how can we interpret it?

The first thing that stands out
is the overall pattern of the points
which is resembles a diagonal line with some variation around it.

When the points in a scatter plot lines up in a pattern
that resembles a diagonal line as in this chart,
it means that the there is a relationship
between the two dataframe columns we have visualized.

In other words,
we can clearly see that as one of the ratings goes up,
so does the other
and there are only a few exceptions to this.

The relationship in this plot would be considered strong
because we can clearly the diagonal trend
that the points follow.

---

## Non-linear relationships follow a predictable pattern that is not a straight line

```{python}
alt.Chart(movies_extended).mark_point().encode(
    alt.X('IMDB Rating'),
    alt.Y('IMDB Votes'))
```

Notes:
The relationship in the previous slide followed a straight line
and we would refer to it as a "linear" relationship.

However,
not all relationships are linear.
In this slide we can see that there appears to be a clear pattern
between the rating and the number of votes a movie receives
but it follows a bent curve
rather than a straight line.

This still appears to be a pretty strong relationship,
but it is a bit hard to tell
because of the many points in a big chunk at the bottom.

When a relationship is not following a straight line,
we say that it is non-linear.
There are many types of non-linear relationships,
but we will not delve into them in course.

---

## The stronger the relationship, the closer together the points are

```{python}
alt.Chart(movies_extended).mark_point().encode(
    alt.X('IMDB Rating'),
    alt.Y('IMDB Rating'))
```

Notes:
If the relationship between two column was really strong,
the points would be very close together
and there would be little variation.

In this plot we have visualized the same column for both the X and Y axis,
which means the relationship is perfect.

We would never expect to see this strong of a relationship in real data,
but it is good to know what are the extreme cases.

On that topic,
let's see what a plot looks like
when there appears to be no relationship 
between the plotted dataframe columns.

## When there is no relationship, there is also no pattern in the plotted points

```{python}
alt.Chart(movies_extended.reset_index()).mark_point().encode(
    alt.X('IMDB Rating'),
    alt.Y('index'))
```

Here,
we have plotted the IMDB Rating
against the row number in the dataframe
(remember that when you reset the index of a dataframe
a new column is created with the previous index / row number).

Unless the data had been ordered in a specific manner previously,
we would expect there to be no relationship
between these two dataframe columns
and that is exactly what we see in this plot.

There is no distinct pattern here,
just a cloud of points.
In other words,
by knowing the value on the x-axis,
there is no way we could know the value on the y-axis.

For example,
a movie with an IMDB Rating of 4-5 could have an index number
anywhere from 0 to 1200.

Let's contrast this with the first visualization we created. 

## A strong relationship means that the value on one axis gives information about the value on the other axis

```{python}
alt.Chart(movies_extended).mark_point().encode(
    alt.X('IMDB Rating'),
    alt.Y('Rotten Tomatoes Rating'))
```

Here, 
knowing the IMDB Rating for a movie
is informative for knowing the Rotten Tomatoes Rating.

For example,
if we know that the IMDB Rating is 4-5,
we can be quite sure that the Rotten Tomatoes Rating
will not exceed 50,
and there are just a few exceptions to this.

However,
we must be careful not to claim
that there is a causal relationship between these two dataframe columns.
All we know is that they have a strong relationship,
we don't know the details of why.

There are formal ways of measure how strong these relationships are,
but they often come with some caveats
and it is generally more informative to look at the visualizations
to understand how the two columns are related to each other.

Remember what we learned in module 1,
people are generally better at detecting visual patterns
than interpreting individual numbers summarizing these relationships.

---

## Saturated scatter plots are difficult to interpret

```{python}
alt.Chart(movies_extended).mark_point().encode(
    alt.X('Production Budget'),
    alt.Y('Worldwide Gross'))
```

Notes:
As we have seen,
scatter plots are generally effective for visualizing two dimensional relationships.
However,
as with all plots,
they have their shortcomings.

Most notably,
when the bulk of the points become concentrated to a small region of the chart,
2D scatter plots become saturated in the same way
as the 1D scatter and rug plots we saw in the previous module.

In this slide we're trying to answer the question:
"Do high grossing movies tend to have a high production budget?"

In the scatter plot you can see
that it it is impossible to tell
if there are more points close to 80 million or 0 on the x-axis,
and likewise 200 million or 0 on the y-axis.

So although we can discern a trend
for the points outside the saturated area
we do not know how they data is spread out inside the blue blob. 

To solve this issue,
we can create a two-dimensional histogram
in the form of a heatmap.

---

## A heatmap can visualize the relationship between two distributions without saturation

```{python}
alt.Chart(movies_extended).mark_rect().encode(
    alt.X('Production Budget', bin=alt.Bin(maxbins=60)),
    alt.Y('Worldwide Gross', bin=alt.Bin(maxbins=60)),
    alt.Color('count()'))
```

Notes:
What's involved in creating a two-dimensional histogram?

This is similar to when we several heatmaps
to compare multiple 1D distributions,
but here we need to bin both the x and y-axis.

These bins will look like a grid or mesh
overlayed on the image,
similar to the pattern of the faint grey gridlines in the previous slide.

Within each rectangle of this grid,
we will count the number of observations
and represent the count value with a color.

The result of these operations is the heatmap shown in this slide,
which enables us to see a level of detail we could not perceive in the scatter plot.

Here it is clear that there are many fewer movies with a production budget of 80 million
compared to the area close to 0,
and most movies seem to be around 10-15 million.
Likewise the grossing of most movies is around 0-50 million,
not 200 million.

---

## A 2D density plot can also visualize the relationship between two distributions without saturation

<img src="/module4/unnamed-chunk-5-1.png" width="48%" />

```{python include=FALSE}
# import seaborn as sns

# ax = sns.kdeplot(
#     data=movies_extended,
#     x='Production Budget',
#     y='Worldwide Gross',
#     fill=True, cmap='YlGn', cut=0, cbar=True)
# sns.despine()
# ax.figure.savefig('../../../../static/module4/unnamed-chunk-5-1.png')
```

Notes:
In addition to representing 2D distributions as heatmaps,
we can also represent them as density plots.

Altair cannot yet make these plots,
so here we're showing an example created 
from another plotting library called seaborn,
so that you can get a sense of what this visualization would look like for our data.

In a 2D density plot,
each bin is now two dimensional
and look like a bell in a clocktower
or the top of a circus tent,
rather than a bell-shaped one-dimensional curve.

This type of visualization gives us similar information
as the heatmap in the previous slide
and the advantages and disadvantages
are similar to those between one-dimensional histograms
and density plots.

As with 1D density plots,
the values of the density themselves are not helpful,
but we have included them here in the colorbar as an example.

---

## Bar charts are effective for visualizing categorical "distributions" of a single column

```{python}
alt.Chart(movies_extended).mark_bar().encode(
    alt.X('count()'),
    alt.Y('Major Genre', sort='x'))
```

Notes:

We have already seen examples of visualizing categorical distributions
when we used bar charts to plot the count of categories in previous modules.

Although these plots represent categorical distributions,
it's good to know that they are commonly referred to
as just showing the counts of the categories,
rather than their "distribution".

Here we have made a bar chart to answer the question
"Which is the most common genre among movies in this dataset?".

We can see that the dataset consists of mostly comedies and dramas
with very few concert/performance films.

---

## Visualizing counts for combinations of two categorical columns can be done via faceting but it's not always effective

```{python}
alt.Chart(movies_extended).mark_bar().encode(
    alt.X('count()'),
    alt.Y('Major Genre', sort='x'),
    alt.Color('MPAA Rating'))
```

Notes:

What if we wanted to ask a more complex question
that involves visualizing the combinatorial counts of two categorical columns?

Our data contains the MPAA rating for each movie,
which is classification given by the Motion Picture Association
indicating what age groups a movie is suitable for:

- G -- General Audiences
- PG -- Parental Guidance Suggested
- PG-13 -- Parents Strongly Cautioned
- R -- Restricted

Do you think there are any differences in
the proportions of ratings
between movie genres?

For example,
we might already have a hypothesis
that there won't be any horror movies that are appropriate for children.

To find out,
we could color the bars according to the MPAA rating as in this slide.
However,
one aspect of our chart is not very intuitive:
the color legend and the stacked bar segments
are not sorted in the same order.

---

## Reordering the bar segments aligns it with the order in the legend

```{python}
alt.Chart(movies_extended).mark_bar().encode(
    alt.X('count()'),
    alt.Y('Major Genre', sort='x'),
    alt.Color('MPAA Rating'),
    alt.Order('MPAA Rating'))
```

Here we have reordered the bar segments using `alt.Order`,
so that they are in the same order as the legend.
We could have opted to reorder the legend instead,
but it is more natural to start with the rating for children (G)
and proceed towards increasingly more mature ratings.

In this chart
we can see that most comedies are rated PG-13,
most dramas are rated R,
that action movies almost only have movies rated either R or PG-13

But this doesn't really answer our question,
which was if there are any differences in
the **proportions** of MPAA ratings
**between** movie genres?

While we can roughly see the relative proportions
within a single bar,
it is quite hard to compare the colored segments between bars as proportions
since the bars are of different length.

It is also impossible to see the proportions in the genres with fewer movies.

---

## Rescaling the bar lengths facilitates comparing proportions between bars

```{python}
alt.Chart(movies_extended).mark_bar().encode(
    alt.X('count()', stack='normalize', title='Proportion of movies'),
    alt.Y('Major Genre', sort='x'),
    alt.Color('MPAA Rating'),
    alt.Order('MPAA Rating'))
```

Here we have changed the strategy
for how the segments are stacked together
by setting `stack='normalize'`,
which means to normalize/rescale each bar
to span the entire length of the x-axis
and label it as a proportion.

The plot looks quite unordered,
because 'x' is not a meaningful way to sort the bars
when they are all the same length.
Instead we would like to sort them
by the length of one of the colored segments.

---

## Sorting by the length of one of the colored segments make the chart easier to rea

```{python}
sort_order = ['Adventure', 'Musical', 'Comedy', 'Romantic Comedy', 'Action',
              'Drama', 'Concert/Performance', 'Documentary', 'Western',
              'Thriller/Suspense', 'Horror', 'Black Comedy'] 
alt.Chart(movies_extended).mark_bar().encode(
    alt.X('count()', stack='normalize', title='Proportion of movies'),
    alt.Y('Major Genre', sort=sort_order),
    alt.Color('MPAA Rating'),
    alt.Order('MPAA Rating'))
```

Notes:

That's much better!
Sorting the chart in an intuitive order
has once again shown to be crucial
for making our plot easier to interpret.

In a normalized stacked bar chart
it makes sense to sort by either the first or the last colored segment.
Since not all genres have movies rated `'G'`,
we chose to set the order based on `'R'` instead.

If you are more interested in one genre than others,
you could also choose to sort by that genre.

Now we can directly compare the the length of individual bar segments
between the genres.
We see that there certainly are differences
in the proportions of MPAA ratings
between movies in different genres.

For the R rating,
it is immediately obvious exactly how big these differences are,
and we can see that all black comedies are rated R,
while almost no adventure movies receive this rating.

It is a little bit harder to compare the other rating because 
the colored segments do not share the same baseline.
We can still see that concerts and performance movies
has the highest proportions of movies that are kids-friendly at 50%,
while musicals, documentaries, and action movies
have around 20% kids-friendly movies.

(We specified the sort order manually in this slide,
because it is rather advanced to extract this order using pandas,
but we include an example in the transcript 
if you are interested in how this could be done:)

```python
sort_order = (
    movies_extended
    .groupby('Major Genre')['MPAA Rating']
    .value_counts(normalize=True)
    .xs('R', level='MPAA Rating')
    .sort_values()
    .index
    .to_list())
```

---

## Normalize stacked bar charts are effective at visualizing just a few categories

```{python}
sort_order = ['Concert/Performance', 'Musical', 'Documentary', 'Adventure', 
              'Comedy', 'Romantic Comedy', 'Drama',  'Action']
alt.Chart(movies_extended[movies_extended['MPAA Rating'].isin(['G', 'PG'])]).mark_bar().encode(
    alt.X('count()', stack='normalize', title='Proportion of movies'),
    alt.Y('Major Genre', sort=sort_order),
    alt.Color('MPAA Rating'),
    alt.Order('MPAA Rating'))
```

Notes:
As with all charts,
there are shortcoming to normalized stacked bar charts as well.
We saw in the last slide that it was a bit harder
to compare the colored segments that did not share a baseline
versus the segments at the ends
where the baseline is the same.

This means that normalized stacked bar charts
are ideal when there are only two categories,
since both segments will be easy to compare
between categories.

We can see an example in this slide
where we filtered the dataset
to contain only movies rated either `'G'` or `'PG'`.
It is easy to make comparison for both the blue and the orange segments.

Stacked bar charts also work fine for 3-4 categories,
but beyond that they are usually ineffective.
Even for 3-4 categories it is often preferred
to show the bars side by side instead of stacked.

---

## Showing bars side by side makes it easier to compare their exact heights within a category

```{python}
(alt.Chart(movies_extended).mark_bar().encode(
    alt.X('count()', title=''),
    alt.Y('MPAA Rating', title=''),
    alt.Color('MPAA Rating', legend=None))
 .properties(width=100, height=45)
 .facet('Major Genre', columns=4)
 .resolve_scale(x='independent'))
```

Notes:
It is not (yet) possible to pass a different value to `stack`,
which would put the bars next to each other.
Instead,
we could use faceting as in this slide.

Here,
we have also removed some of the axis title to make the figure more compact
and less crowded with text.
You will learn more about customizing elements
such as titles in the next module.

By resolving the x-scale to be independent between the plots,
the bar height is not relative the max in each facet.
This makes them easier to compare **as proportions** both within and between facets
while still retaining an indication of the count on the x-axis.

If we wanted to compare the absolute counts between facets,
we would leave the axis axis at its default value: "shared". 

This type of visualization is effective
when we want to accurately compare the heights of bars
**within** a genre.
For example to answer the question:
"Which are the most common MPAA ratings for each genre?".

---

## Switching the faceting and y column targets the plot towards a slightly different question

```{python}
(alt.Chart(movies_extended).mark_bar().encode(
    alt.X('count()', title=''),
    alt.Y('Major Genre', title='', sort='x'),
    alt.Color('MPAA Rating', legend=None))
 .properties(width=100, height=150)
 .facet('MPAA Rating')
 .resolve_scale(x='independent'))
```

Notes:
If we instead wanted to answer the question:
"Which are the most common genres for each MPAA Rating?",
we would switch the faceting and y columns.

Here,
we kept the color column as the MPAA Rating
so that it is consistent with the previous figures,
and because with this many categories,
it would look quite messy if we colored by the Major Genre instead.

We can see that the most common G-rated movies are adventure films,
and that most PG-13 rated movies are Comedies, Dramas and action movies.
It is important to remember that genres have more movies in total,
so we would expect them to show up highly in all the facets.
Whether this is desired or not depends on the question we are asking,
but it does make sense here.

---

## Heatmaps are effective for visualizing counts of two dimensional categorical data

```{python}
alt.Chart(movies_extended).mark_rect().encode(
    alt.Color('count()'),
    alt.X('MPAA Rating'),
    alt.Y('Major Genre', sort='color'))
```

Notes:

If we want to get an overview of the information
from both the faceted plots in the previous two slides,
we could create a heatmap.
In this heatmap
the color represents the combinatorial counts of two categorical columns,
such as how many movies are both rated G and in the comedy genre.

Comparing squares vertically in this heatmap
is similar to the first faceted plot we made
and comparing them horizontally
is similar to the faceted visualization in the last slide.

In other words,
if we want to compare which genre is most common for a certain rating,
we compare the colors *column-wise* in the heatmap.
If we instead are interested in the most common rating assigned to a movie
we compare the columns *row-wise*.
We can quickly see that most dramas are rated PG-13 or R
and most horror movies are rated R.

Sorting on color/count puts the genres with many observations close together,
similar to how we sorted on `'x'` and `'y'` in previous modules.
We could sort the x-axis also,
but since it has a natural order to it,
we have decided to keep it as is here.

This visualization is effective
for quickly communicating the main takeaways from the two questions
and giving us an overview of the data,
but it is harder  to tell that exact count for each color
so if that is of great importance a bar chart is more suitable.

---

## Using both the color and marker size to indicate the count creates a more effective visualization

```{python}
alt.Chart(movies_extended).mark_circle().encode(
    alt.X('MPAA Rating'),
    alt.Y('Major Genre', sort='color'),
    alt.Color('count()'),
    alt.Size('count()'))
```

Notes:
One potential concern with heatmaps
is that they rely solely on color to communicate the value of interest.

We cannot perceive small variations in color
as accurately as we can for other visual channels,
such as position of size.

Color can also be problematic for people with color vision deficiencies,
which is almost 10% of the population,
which we will talk more about in a later module.

To ameliorate these issues,
we can use the same marks as when creating scatter plots,
such as `mark_circle` or `mark_square`,
which allows us to change the size of each mark in addition to its color.

This visualization is highly effective in answering both of the questions we posed initially,
and if we wanted to,
we could now facet by a third categorical column 
such as the movie distributor,
to interrogate three categorical columns simultaneously.

---

# Let's apply what we learned!

Notes: <br>
